#!/bin/bash

set -eu -o pipefail

# Runs the unit tests on another host.  Required because our tests need to
# run as root, and you probably don't want to do that on your development
# machine.
#
# To skip slow tests, run this with: --exclude slow:true

remote=sandlin

# Compile on local machine, because we want to
# 1) compile deps/ despite the --no-deps-check used on the test machine,
#    which we use because it doesn't have the source git repositories
# 2) get compilation errors faster
# 3) avoid mix mistakenly not compiling files on the test machine, when
#    its clock is in the future
MIX_ENV=test mix compile

rsync -av --delete --delete-excluded --exclude=.git \
	$HOME/opt/elixir \
	$HOME/code/erlang/converge \
	root@"$remote":

# Need to rm -rf _build/ or else `mix test` will use stale .beam files
# when the remote's clock is in the future.
ssh root"@$remote" "
cd converge &&
PATH=/root/elixir/bin:\$PATH mix test --no-deps-check --trace --color $@"
